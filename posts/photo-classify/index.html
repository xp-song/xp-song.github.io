<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="XP Song">
<meta name="dcterms.date" content="2020-01-08">
<meta name="description" content="Classify images based on keywords generated from the Google Cloud Vision API">

<title>XP Song - Automated image classification into content-type categories</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/icon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-WS5CZJ06W0"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-WS5CZJ06W0', { 'anonymize_ip': true});
</script>
<style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: #242F36;
      }

      .quarto-title-block .quarto-title-banner {
        color: #242F36;
      }
</style>

<script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


<meta property="og:title" content="XP Song - Automated image classification into content-type categories">
<meta property="og:description" content="Classify images based on keywords generated from the Google Cloud Vision API">
<meta property="og:image" content="https://xp-song.github.io/posts/photo-classify/featured.png">
<meta property="og:site-name" content="XP's Website">
<meta property="og:image:width" content="630">
<meta property="og:image:height" content="373">
<meta name="twitter:title" content="XP Song - Automated image classification into content-type categories">
<meta name="twitter:description" content="Classify images based on keywords generated from the Google Cloud Vision API">
<meta name="twitter:image" content="https://xp-song.github.io/posts/photo-classify/featured.png">
<meta name="twitter:creator" content="@song_xiaoping">
<meta name="twitter:image-height" content="373">
<meta name="twitter:image-width" content="630">
<meta name="twitter:card" content="summary_large_image">
<meta name="citation_title" content="Using social media user attributes to understand human–environment interactions at urban parks">
<meta name="citation_author" content="Song, X. P.">
<meta name="citation_author" content="Richards, D.R.">
<meta name="citation_author" content="Tan, P.Y.">
<meta name="citation_publication_date" content="2020-01-08">
<meta name="citation_cover_date" content="2020-01-08">
<meta name="citation_year" content="2020">
<meta name="citation_online_date" content="2020-01-08">
<meta name="citation_fulltext_html_url" content="https://xp-song.github.io/posts/photo-classify">
<meta name="citation_doi" content="10.1038/s41598-020-57864-4">
<meta name="citation_volume" content="10">
<meta name="citation_language" content="en">
<meta name="citation_firstpage" content="808">
<meta name="citation_journal_title" content="Scientific Reports">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../images/icon.png" alt="XP's Website" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../academia.html" rel="" target="">
 <span class="menu-text">Academia</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../music.html" rel="" target="">
 <span class="menu-text">Music</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Automated image classification into content-type categories</h1>
                  <div>
        <div class="description">
          Classify images based on keywords generated from the Google Cloud Vision API
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">Research</div>
                <div class="quarto-category">Tutorials</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://xp-song.github.io">XP Song</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 8, 2020</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#generate-keywords" id="toc-generate-keywords" class="nav-link active" data-scroll-target="#generate-keywords">Generate Keywords</a></li>
  <li><a href="#classify-photos" id="toc-classify-photos" class="nav-link" data-scroll-target="#classify-photos">Classify Photos</a>
  <ul class="collapse">
  <li><a href="#A" id="toc-A" class="nav-link" data-scroll-target="#A">A. Distance matrix and clustering</a></li>
  <li><a href="#B" id="toc-B" class="nav-link" data-scroll-target="#B">B. How many clusters?</a></li>
  </ul></li>
  <li><a href="#visualise-results" id="toc-visualise-results" class="nav-link" data-scroll-target="#visualise-results">Visualise Results</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>This tutorial describes the workflow and R code that can be used to classify a large number of images into <em>discrete</em> categories, based on their content. The source documents are available on <a href="https://github.com/xp-song/photo-classify">GitHub</a>. This tutorial provides supplementary information to the following publication:</p>
<blockquote class="blockquote">
<p>Song, X.P., Richards, D.R., Tan, P.Y. (2020). Using social media user attributes to understand human–environment interactions at urban parks, <em>Scientific Reports</em>, <em>10</em>, 808. <a href="https://doi.org/10.1038/s41598-020-57864-4" class="uri">https://doi.org/10.1038/s41598-020-57864-4</a></p>
</blockquote>
<p>An earlier iteration of the code was used in <a href="https://doi.org/10.1016/j.ecoser.2017.09.004">this publication</a>. Note that there are <a href="https://doi.org/10.1016/J.ECOLIND.2018.08.035">numerous other ways to classify images</a>, including those that deal with overlapping content.</p>
<p>&nbsp;</p>
<hr>
<p>The dataset <code>photos</code> is used as an example. It contains 50 photos with a column of photo <em>source</em> URLs. These are sent to the Google Cloud Vision Application Programming Interface (API), to generate up to ten keyword labels per photo.</p>
<p>Note that you will need to have signed-up with the Google Cloud Platform and generated your Client ID and Client secret. We will be using the <a href="https://cran.r-project.org/web/packages/googleAuthR/index.html">googleAuthR</a> and <a href="https://github.com/cloudyr/RoogleVision">RoogleVision</a> packages to interact with the API.</p>
<p>&nbsp;</p>
<p>First few rows of the <code>photos</code> dataset:</p>
<div class="cell">
<div class="cell-output-display">
<div class="table-responsive">
<table class="table table-striped table-condensed table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">photoid</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">url</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">29993180834</td>
<td style="text-align: left;">https://farm6.staticflickr.com/5641/29993180834_8179c87aa7_z.jpg</td>
</tr>
<tr class="even">
<td style="text-align: left;">7002246829</td>
<td style="text-align: left;">https://farm7.staticflickr.com/6240/7002246829_d114f402e7_z.jpg</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5466070643</td>
<td style="text-align: left;">https://farm6.staticflickr.com/5216/5466070643_759428f4a5_z.jpg</td>
</tr>
<tr class="even">
<td style="text-align: left;">16303185765</td>
<td style="text-align: left;">https://farm9.staticflickr.com/8571/16303185765_4dd4d48b7b_z.jpg</td>
</tr>
<tr class="odd">
<td style="text-align: left;">30414187771</td>
<td style="text-align: left;">https://farm6.staticflickr.com/5503/30414187771_5283977ca6_z.jpg</td>
</tr>
<tr class="even">
<td style="text-align: left;">16065397248</td>
<td style="text-align: left;">https://farm9.staticflickr.com/8593/16065397248_7a6a0666b1_z.jpg</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>&nbsp;</p>
<p>Plug-in your Google Cloud Platform credentials:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(googleAuthR)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"googleAuthR.client_id"</span> <span class="ot">=</span> <span class="st">"xxx.apps.googleusercontent.com"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"googleAuthR.client_secret"</span> <span class="ot">=</span> <span class="st">""</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"googleAuthR.scopes.selected"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"https://www.googleapis.com/auth/cloud-platform"</span>))</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>googleAuthR<span class="sc">::</span><span class="fu">gar_auth</span>() <span class="co">#You will be directed to a weblink to sign-in with your account</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>&nbsp;</p>
<hr>
<section id="generate-keywords" class="level1">
<h1>Generate Keywords</h1>
<p>Create a loop to send each photo URL to the Google Cloud Vision API, and append the results to <code>photos</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(RoogleVision) </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#add extra columns for 10 x 3 rows of data (keyword, probability score, and topicality score)</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>photos[,<span class="dv">3</span><span class="sc">:</span><span class="dv">32</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="do">##Loop##</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(photos<span class="sc">$</span>url)){ </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  te <span class="ot">&lt;-</span> <span class="fu">getGoogleVisionResponse</span>(photos<span class="sc">$</span>url[i], <span class="at">feature=</span><span class="st">"LABEL_DETECTION"</span>, <span class="at">numResults =</span> <span class="dv">10</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#If not successful, return NA matrix</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(te)<span class="sc">==</span><span class="dv">1</span>){ te <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="dv">10</span>,<span class="dv">4</span>)} </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(te)){ te <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="dv">10</span>,<span class="dv">4</span>)}</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  te <span class="ot">&lt;-</span> te[,<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">#if successful but no. of keywords &lt;10, put NAs in remaining rows</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(te[,<span class="dv">1</span>])<span class="sc">&lt;</span><span class="dv">10</span>){</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    te[(<span class="fu">length</span>(te[,<span class="dv">1</span>])<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="dv">10</span>,] <span class="ot">&lt;-</span> <span class="cn">NA</span>}  </span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Append all data</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  photos[i, <span class="dv">3</span><span class="sc">:</span><span class="dv">12</span>] <span class="ot">&lt;-</span> te[,<span class="dv">1</span>] <span class="co">#keywords</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  photos[i, <span class="dv">13</span><span class="sc">:</span><span class="dv">22</span>] <span class="ot">&lt;-</span> te[,<span class="dv">2</span>] <span class="co">#probability scores</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  photos[i, <span class="dv">23</span><span class="sc">:</span><span class="dv">32</span>] <span class="ot">&lt;-</span> te[,<span class="dv">3</span>] <span class="co">#topicality scores</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"&lt;row"</span>, i, <span class="st">"/"</span>, <span class="fu">length</span>(photos[,<span class="dv">1</span>]), <span class="st">"&gt; "</span>)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>&nbsp;</p>
<p>Keyword results for the first few rows of the <code>photos</code> dataset:</p>
<div class="cell" data-rownames.print="false" data-cols.print="5">
<div class="cell-output-display">
<div class="table-responsive">
<table class="table table-striped table-condensed table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">w1</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">w2</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">w3</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">w4</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">w5</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">w6</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">w7</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">w8</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">w9</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">w10</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">tree</td>
<td style="text-align: left;">nature</td>
<td style="text-align: left;">vegetation</td>
<td style="text-align: left;">sky</td>
<td style="text-align: left;">borassus flabellifer</td>
<td style="text-align: left;">plant</td>
<td style="text-align: left;">palm tree</td>
<td style="text-align: left;">woody plant</td>
<td style="text-align: left;">arecales</td>
<td style="text-align: left;">tropics</td>
</tr>
<tr class="even">
<td style="text-align: left;">sea</td>
<td style="text-align: left;">water</td>
<td style="text-align: left;">wave</td>
<td style="text-align: left;">ocean</td>
<td style="text-align: left;">beach</td>
<td style="text-align: left;">square</td>
<td style="text-align: left;">calm</td>
<td style="text-align: left;">surfing equipment and supplies</td>
<td style="text-align: left;">surfboard</td>
<td style="text-align: left;">horizon</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bird</td>
<td style="text-align: left;">fauna</td>
<td style="text-align: left;">beak</td>
<td style="text-align: left;">wren</td>
<td style="text-align: left;">wildlife</td>
<td style="text-align: left;">old world flycatcher</td>
<td style="text-align: left;">piciformes</td>
<td style="text-align: left;">woodpecker</td>
<td style="text-align: left;">twig</td>
<td style="text-align: left;">perching bird</td>
</tr>
<tr class="even">
<td style="text-align: left;">plant</td>
<td style="text-align: left;">flora</td>
<td style="text-align: left;">leaf</td>
<td style="text-align: left;">tree</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sitting</td>
<td style="text-align: left;">leg</td>
<td style="text-align: left;">fun</td>
<td style="text-align: left;">vacation</td>
<td style="text-align: left;">human body</td>
<td style="text-align: left;">vehicle</td>
<td style="text-align: left;">car</td>
<td style="text-align: left;">hand</td>
<td style="text-align: left;">muscle</td>
<td style="text-align: left;">recreation</td>
</tr>
<tr class="even">
<td style="text-align: left;">bird</td>
<td style="text-align: left;">fauna</td>
<td style="text-align: left;">beak</td>
<td style="text-align: left;">finch</td>
<td style="text-align: left;">feather</td>
<td style="text-align: left;">wildlife</td>
<td style="text-align: left;">perching bird</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>&nbsp;</p>
<hr>
</section>
<section id="classify-photos" class="level1 tabset tabset-fade tabset-pills">
<h1 class="tabset tabset-fade tabset-pills">Classify Photos</h1>
<p>Next, we prepare the keywords to be used to perform hierarchical clustering of photos. Since hierarchical clustering tends to be very memory intensive, you may want to run the following code on a high performance computing cluster (depending on the number of photos you have). Parallel computing can be used to speed up memory-intensive loops, using the R packages <a href="https://cran.r-project.org/web/packages/foreach/index.html">foreach</a> and <a href="https://cran.r-project.org/web/packages/doParallel/index.html">doParallel</a>.</p>
<p>&nbsp;</p>
<p>Set-up your machine for parallel computing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(foreach)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(doParallel)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#setup parallel backend to use many processors</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of cores = "</span>, <span class="fu">detectCores</span>())</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="fu">detectCores</span>(), <span class="at">outfile=</span><span class="fu">paste0</span>(<span class="st">'./admin/info_parallel.log'</span>)) <span class="co">#log file with info</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(cl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>&nbsp;</p>
<p>Before we begin clustering the entire dataset, however, we need to find out how many clusters to group the photos into. If your dataset is large, it may be better to first test the outcomes of different numbers of clusters on a <strong><em>subset</em></strong> of your data. <em>If so, proceed with the following <strong>two</strong> sub-sections on a <strong>random subset</strong> of your data, before re-running the <strong>first</strong> sub-section (<a href="#A"><strong>A. Distance matrix and clustering</strong></a>) the with the <strong>full</strong> dataset.</em></p>
<p>&nbsp;</p>
<hr>
<section id="A" class="level2">
<h2 class="anchored" data-anchor-id="A">A. Distance matrix and clustering</h2>
<p>Extract all the unique keywords across <code>photos</code> (or subset of <code>photos</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>words <span class="ot">&lt;-</span> <span class="fu">unlist</span>(photos[,<span class="dv">3</span><span class="sc">:</span><span class="dv">12</span>])</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>words <span class="ot">&lt;-</span> words[<span class="sc">!</span><span class="fu">duplicated</span>(words)] <span class="co">#list of unique keywords</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>&nbsp;</p>
<p>Next, we convert <code>photos</code> into a binary format and name it <code>wordscore</code>, with each row representing a photo, and each column representing a keyword. “1” is added if the word is present. We then convert <code>wordscore</code> into a sparse matrix. This will help reduce the load on the computer’s RAM, especially if the photo dataset is very large.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#parallel loop:</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>wordscore <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(photos[,<span class="dv">1</span>]), <span class="at">.combine=</span>rbind) <span class="sc">%dopar%</span> {</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  vec <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"integer"</span>,<span class="at">length =</span> <span class="fu">length</span>(words))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> <span class="fu">match</span>(photos[i,<span class="dv">3</span><span class="sc">:</span><span class="dv">12</span>], words)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  vec[a] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">" row "</span>, i), <span class="at">file=</span><span class="fu">paste0</span>(<span class="st">"admin/log_wordscore.txt"</span>), <span class="at">append=</span><span class="cn">TRUE</span>) <span class="co">#The loop's progress will be printed in this file</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  vec</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(wordscore) <span class="ot">&lt;-</span> words</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(wordscore) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>wordscore <span class="ot">&lt;-</span> wordscore[,<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">colnames</span>(wordscore))] <span class="co">#remove 'NA' keyword if present</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix) </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>wordscore <span class="ot">&lt;-</span> <span class="fu">Matrix</span>(wordscore, <span class="at">sparse =</span> <span class="cn">TRUE</span>)  <span class="co">#convert to sparseMatrix to save memory</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>&nbsp;</p>
<p>In the binary format, <code>wordscore</code> can now be converted into a distance matrix. To have a fair assessment of the similarity (and thus the distance) between two photos, we need to take into account if they have the same number of keywords generated. The Jaccard Index is used in the calculation, where the number of common keywords is divided by the total number of unique keywords between two photos.</p>
<p>To start with, we find out how many keywords each photo has (up to ten), and save the results as the vector <code>lengword</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>narmlength <span class="ot">&lt;-</span> <span class="cf">function</span>(x){<span class="dv">10</span><span class="sc">-</span><span class="fu">sum</span>(<span class="fu">is.na</span>(x))} <span class="co">#create function</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>lengword <span class="ot">&lt;-</span> <span class="fu">apply</span>(photos[,<span class="dv">3</span><span class="sc">:</span><span class="dv">12</span>], <span class="dv">1</span>, narmlength) <span class="co">#apply function</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>&nbsp;</p>
<p>Next, the similarity between each photo and all other photos is calculated manually in a loop, based on the Jaccard Index. Since most photos do not share keywords, the similarity value will tend to be “0” (less strain on computer’s RAM). The similarity matrix (loop output) is then converted into a distance matrix, and subsequently converted into a ‘<code>dist</code>’ object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>simimat <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(wordscore[,<span class="dv">1</span>]), <span class="at">.packages =</span> <span class="st">"Matrix"</span>, <span class="at">.combine=</span>cbind) <span class="sc">%dopar%</span> {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  ws <span class="ot">&lt;-</span> wordscore[,<span class="fu">which</span>(wordscore[i,] <span class="sc">==</span> <span class="dv">1</span>)] <span class="co">#for each photo, find the other photos (rows) with its keywords (cols)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  simi <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">apply</span>(<span class="fu">as.matrix</span>(ws),<span class="dv">1</span>,sum, <span class="at">na.rm=</span>T)<span class="sc">/</span>(lengword<span class="sc">+</span>lengword[i]),<span class="dv">2</span>) <span class="co">#Jaccard index</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  simi[<span class="dv">1</span><span class="sc">:</span>i] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#only fill half the matrix</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  simi[i] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"row"</span>,i), <span class="at">file=</span><span class="fu">paste0</span>(<span class="st">"admin/log_simimat.txt"</span>), <span class="at">append=</span><span class="cn">TRUE</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  simi</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(simimat) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(wordscore, lengword)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="co">#convert similarity to distance</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>distmat <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>simimat</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(simimat)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="co">#Convert to a 'dist' object</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>dm <span class="ot">&lt;-</span> <span class="fu">as.dist</span>(distmat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>&nbsp;</p>
<p>Finally, we perform hierarchical clustering of photos, using Ward’s distance:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(fastcluster)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(graphics)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>cluz <span class="ot">&lt;-</span> fastcluster<span class="sc">::</span><span class="fu">hclust</span>(dm, <span class="st">"ward.D2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>&nbsp;</p>
<p><em>Go to ‘<a href="#B"><strong>B. How many clusters?</strong></a>’ if the number of photo categories has not been determined.</em></p>
<p>&nbsp;</p>
<hr>
</section>
<section id="B" class="level2">
<h2 class="anchored" data-anchor-id="B">B. How many clusters?</h2>
<p>This section runs as a separate analysis from the final results. Note that the following script may take a long time to run if you have a large dataset.</p>
<p>In this analysis, we measure the average difference between within- and between-cluster variation, across different clustering scenarios. Thus, a higher value suggests distinct clusters that are more ‘different’ from each other (i.e.&nbsp;greater variation/distance between clusters). As the number of clusters (<em>k</em>) increases, this value is expected to decrease. We plot these values, and use the L-Method to find the ‘knee’ of the evaluation graph. More information about the L-Method can be found at:</p>
<blockquote class="blockquote">
<p>Salvador, S. &amp; Chan, P. Determining the Number of Clusters / Segments in Hierarchical Clustering / Segmentation Algorithms. in 16th <em>IEEE International Conference on Tools with Artificial Intelligence</em> 576-584 (IEEE, 2004). doi:10.1109/ICTAI.2004.50</p>
</blockquote>
<p>&nbsp;</p>
<p>First, decide up to how many clusters (<em>k</em>) to test for. In this example, we test <em>k</em> from 2 to 20, and save it as the vector <code>scenarios</code> (19 scenarios):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>scenarios <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>&nbsp;</p>
<p>Create a function to measure the difference between within- and between-cluster variation across all photos. Run the function for different <em>k</em> values in <code>scenarios</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>differ <span class="ot">&lt;-</span> <span class="cf">function</span>(dist, gr, pos){</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#dist is a single photo's vector of distances with all others</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#gr is the vector output of grp membership across all photos</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#pos is the position of the single photo in length(distmat[1,])</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  gr2 <span class="ot">&lt;-</span><span class="fu">numeric</span>(<span class="fu">length</span>(gr)) <span class="co">#vector of "0"s</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  gr2[gr<span class="sc">==</span>gr[pos]] <span class="ot">&lt;-</span><span class="dv">1</span> <span class="co">#Which photos are in same cluster as the photo of interest?</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  gr3 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">tapply</span>(dist,gr2, mean) <span class="co">#2 values generated: (1) mean distance compared to photos in other clusters, &amp; (2) compared to photos within same cluster. Minus values from one to convert to similarity value.</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  gr3[<span class="dv">2</span>]<span class="sc">-</span>gr3[<span class="dv">1</span>] <span class="co">#within-cluster minus between-cluster similarity (larger value means clusters are very different)</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">#Run function for different scenarios (numbers of clusters):</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>(<span class="fu">length</span>(scenarios)<span class="sc">+</span><span class="dv">1</span>)){</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  grp <span class="ot">&lt;-</span> <span class="fu">cutree</span>(cluz, <span class="at">k=</span>i)  <span class="co">#cutree returns vector of grp memberships across all photos</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">&lt;&lt; Working on scenario k ="</span>, i, <span class="st">"/"</span>, (<span class="fu">length</span>(scenarios)<span class="sc">+</span><span class="dv">1</span>), <span class="st">"&gt;&gt;</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  alldiffer <span class="ot">&lt;-</span><span class="fu">numeric</span>(<span class="fu">length</span>(distmat[,<span class="dv">1</span>])) <span class="co">#vector of "0"s"</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(distmat[,<span class="dv">1</span>])){ <span class="co">#run function for each photo (across rows)</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    alldiffer[j]<span class="ot">&lt;-</span> <span class="fu">differ</span>(distmat[j,], grp, j )</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"&lt;row"</span>, j, <span class="st">"/"</span>, <span class="fu">length</span>(distmat[,<span class="dv">1</span>]), <span class="st">"photos&gt;"</span>)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  scenarios[i<span class="dv">-1</span>]<span class="ot">&lt;-</span><span class="fu">mean</span>(alldiffer) <span class="co">#find out the mean difference for each scenario (k)</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">&lt;&lt; Scenario k ="</span>, i, <span class="st">"COMPLETE &gt;&gt;"</span>)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="co">#Create dataframe</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>scenarios <span class="ot">&lt;-</span> <span class="fu">cbind.data.frame</span>(<span class="fu">seq</span>(<span class="dv">2</span>,(<span class="fu">length</span>(scenarios)<span class="sc">+</span><span class="dv">1</span>),<span class="dv">1</span>), <span class="dv">1</span><span class="sc">-</span>scenarios) <span class="co">#convert to distance</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(scenarios) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"k"</span>, <span class="st">"distance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Do note that the small number of photos in our example produces a relatively straight curve. To help with visualisation, we can also calculate the marginal change in the distance:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(scenarios<span class="sc">$</span>distance)){</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  scenarios[i,<span class="dv">3</span>] <span class="ot">&lt;-</span> scenarios<span class="sc">$</span>distance[i<span class="dv">-1</span>]<span class="sc">-</span>scenarios<span class="sc">$</span>distance[i]</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(scenarios) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"k"</span>,<span class="st">"distance"</span>,<span class="st">"marginalDelta"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are plots of the results across different clustering scenarios:</p>
<div class="cell quarto-layout-panel" data-fig.asp="1" data-fig.ncol="2">

</div>
<center>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/cluster_results.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Differences between within- and between-cluster variation, across different clustering scenarios</figcaption>
</figure>
</div>
</center>
<p>&nbsp;</p>
<p>Since such plots may not always allow us to visually determine the appropriate number of photo clusters, we can also use the L-Method as described in Salvador and Chan (2004). To do so, we plot possible pairs of best-fit lines to the curve, and calculate the total root mean squared error (RMSE) for each pair. The lowest RMSE value is used to determine the number of clusters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(rgl)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(qpcR)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Best-fit line equation:</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>mod1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(distance <span class="sc">~</span> k, <span class="at">data =</span> scenarios)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">#Equation from Salvador &amp; Chan (2004):</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">3</span><span class="sc">:</span>(<span class="fu">max</span>(scenarios<span class="sc">$</span>k)<span class="sc">-</span><span class="dv">2</span>)){  <span class="co">#lowest value the 'knee' can be at is 3</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  rmse <span class="ot">&lt;-</span>  ((i<span class="dv">-1</span>)<span class="sc">/</span>(<span class="fu">max</span>(scenarios<span class="sc">$</span>k)<span class="sc">-</span><span class="dv">1</span>)<span class="sc">*</span>(<span class="fu">RMSE</span>(mod1, <span class="at">which =</span> <span class="dv">2</span><span class="sc">:</span>i))) <span class="sc">+</span> (((<span class="fu">max</span>(scenarios<span class="sc">$</span>k)<span class="sc">-</span>i)<span class="sc">/</span>(<span class="fu">max</span>(scenarios<span class="sc">$</span>k)<span class="sc">-</span><span class="dv">1</span>))<span class="sc">*</span><span class="fu">RMSE</span>(mod1, <span class="at">which =</span> (i<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="fu">max</span>(scenarios<span class="sc">$</span>k)))</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>scenarios[i<span class="dv">-1</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> rmse</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(scenarios) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"k"</span>,<span class="st">"distance"</span>, <span class="st">"marginalDelta"</span>, <span class="st">"Lrmse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>&nbsp;</p>
<p>Now we can plot RMSE across an increasing number of clusters (k). In our example, the lowest RMSE value is where k = <code>11</code>. This is the ‘knee’ of the graph. Note that there are a roughly balanced number of points on either side of this value.</p>
<center>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/rmse.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Total RMSE of possible pairs of best-fit lines</figcaption>
</figure>
</div>
</center>
<p>&nbsp;</p>
<p>Now it’s time to classify our photos and visualise the categories for good. <em>Go back to ‘<a href="#A"><strong>A. Distance matrix and clustering</strong></a>’ and re-run the script for the full dataset if a subset of data was used to determine the number of clusters.</em> If not, continue on to the next section…</p>
<p>&nbsp;</p>
<hr>
</section>
</section>
<section id="visualise-results" class="level1">
<h1>Visualise Results</h1>
<p>Finally, classify the full dataset into <code>11</code> clusters:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>grp <span class="ot">&lt;-</span> <span class="fu">cutree</span>(cluz, <span class="at">k=</span><span class="dv">11</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>photos <span class="ot">&lt;-</span> <span class="fu">cbind.data.frame</span>(photos, grp, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>) <span class="co">#Final dataframe</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="do">##Plot##</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">as.dendrogram</span>(cluz), <span class="at">sub =</span> <span class="st">""</span>, <span class="at">xlab =</span><span class="st">""</span>, <span class="at">ylab =</span> <span class="st">"Height"</span>, <span class="at">main =</span> <span class="st">"Hierarchical clustering of photos into 11 categories"</span>, <span class="at">cex.main =</span> <span class="fl">0.95</span>, <span class="at">leaflab =</span> <span class="st">"none"</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rect.hclust</span>(cluz, <span class="at">k =</span> <span class="dv">11</span>, <span class="at">border =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="assets/visual.png" class="img-fluid"></p>
<p><br></p>
<p>This post is also shared on <a href="https://r-bloggers.com">R-bloggers.com</a>.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@article{x. p.2020,
  author = {X. P. , Song and D.R. , Richards and P.Y. , Tan},
  title = {Using Social Media User Attributes to Understand
    Human–Environment Interactions at Urban Parks},
  journal = {Scientific Reports},
  volume = {10},
  pages = {808},
  date = {2020-01-08},
  url = {https://xp-song.github.io/posts/photo-classify},
  doi = {10.1038/s41598-020-57864-4},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-x. p.2020" class="csl-entry quarto-appendix-citeas" role="listitem">
X. P., Song, Richards D.R., and Tan P.Y. 2020. <span>“Using Social Media
User Attributes to Understand Human–Environment Interactions at Urban
Parks.”</span> <em>Scientific Reports</em> 10 (January): 808. <a href="https://doi.org/10.1038/s41598-020-57864-4">https://doi.org/10.1038/s41598-020-57864-4</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="xp-song/xpsong_giscus" data-repo-id="R_kgDOH9R2Fw" data-category="Announcements" data-category-id="DIC_kwDOH9R2F84CRT77" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light_protanopia" data-lang="en" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">© 2023 Xiao Ping Song. Built with <a href="https://quarto.org/">Quarto</a>.</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="mailto:xpsong.connect@gmail.com">Contact</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://creativecommons.org/licenses/by-sa/4.0/">License</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../../blog.xml">RSS</a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>